services:
  server:
    image: mysql:latest
    restart: unless-stopped
    hostname: db
    secrets:
      - ca-root-cert
      - db-cert
      - db-key
      - db-root-password
      - db-password
    volumes:
      - ./server/imovies_users.dump:/docker-entrypoint-initdb.d/init.sql:ro
      - ./server/update.sql:/docker-entrypoint-initdb.d/update.sql:ro
      - db-data:/var/lib/mysql
      - db-logs:/var/lib/mysql-files
    environment:
      - TZ=Etc/UTC
      - MYSQL_DATABASE=imovies
      - MYSQL_ROOT_PASSWORD_FILE=/run/secrets/db-root-password
      - MYSQL_USER=web
      - MYSQL_PASSWORD_FILE=/run/secrets/db-password
    command:
      - --default-authentication-plugin=caching_sha2_password
      - --ssl-ca=/run/secrets/ca-root-cert
      - --ssl-cert=/run/secrets/db-cert
      - --ssl-key=/run/secrets/db-key
      - --require-secure-transport=ON
      - --log-error=/var/lib/mysql-files/error.log
      - --general-log=1
      - --general-log-file=/var/lib/mysql-files/general.log
    ports:
      - "${DB_PORT}:3306"
    healthcheck:
      test: ['CMD-SHELL', 'mysqladmin ping -h 127.0.0.1 -u root --password="$$(cat /run/secrets/db-root-password)" --silent']
      interval: 3s
      retries: 5
      start_period: 30s
    user: 999:999
  scheduled-backup:
    image: creativeprojects/resticprofile:latest
    restart: unless-stopped
    hostname: db
    secrets:
      - ca-root-cert
      - db-bak-repository
      - db-bak-password
    volumes:
      - ./scheduled-backup/profiles.yaml:/etc/resticprofile/profiles.yaml:ro
      - db-data:/resticprofile/db-data
    environment:
      - TZ=Etc/UTC
    entrypoint: /bin/sh
    command: ['-c', 'resticprofile schedule --all && crond -f']
    user: 0:0  #Â Requires root to run 'resticprofile schedule'
  logger:
    build:
      context: logger
    restart: unless-stopped
    hostname: db
    secrets:
      - ca-root-cert
    volumes:
      - ./logger/rsyslog.conf:/etc/rsyslog.conf:ro
      - db-logs:/var/log/mysql
    environment:
      - TZ=Etc/UTC
      - CONTAINER_SILENT=on
    user: 0:0  # Requires root to read db-logs
secrets:
  ca-root-cert:
    file: secrets/root.imovies.ch.crt
  db-cert:
    file: secrets/db.imovies.ch.crt
  db-key:
    file: secrets/db.imovies.ch.key
  db-root-password:
    file: secrets/db_root_password.txt
  db-password:
    file: secrets/db_password.txt
  db-bak-repository:
    file: secrets/bak_repository.txt
  db-bak-password:
    file: secrets/bak_password.txt
volumes:
  db-data:
  db-logs:
